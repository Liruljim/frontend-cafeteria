<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clientes | CafeterÃ­a</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body data-page="customers" class="bg-gray-900 text-white min-h-screen">
    <div class="flex min-h-screen">
        <div id="sidebar-slot"></div>
        <main class="flex-1">
            <div id="topbar-slot"></div>

            <div class="p-4 max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">GestiÃ³n de Clientes</h1>
                    <button id="btnNewClient" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                        <span>+</span> Nuevo Cliente
                    </button>
                </div>


                <div class="mb-4">
                    <input type="text" id="searchInput" placeholder="Buscar por nombre o cÃ©dula..." 
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none">
                </div>


                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-lg">
                    <table class="w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-700/50 uppercase font-bold text-gray-400">
                            <tr>
                                <th class="px-6 py-3">Nombre Completo</th>
                                <th class="px-6 py-3">CÃ©dula/RIF</th>
                                <th class="px-6 py-3">TelÃ©fono</th>
                                <th class="px-6 py-3">Email</th>
                                <th class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody" class="divide-y divide-gray-700">
                           <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Cargando clientes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>


    <div id="clientModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl w-full max-w-2xl border border-gray-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-700 bg-gray-900 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Nuevo Cliente</h3>
                <button id="closeModal" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            
            <form id="clientForm" class="p-6 overflow-y-auto flex-1 space-y-4">
                <input type="hidden" id="clientId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1">Nombre *</label>
                        <input type="text" id="nombre" required class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1">Apellido</label>
                        <input type="text" id="apellido" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1">CÃ©dula/RIF *</label>
                        <div class="flex gap-2">
                            <select id="nac" class="w-20 bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                                <option value="V">V</option>
                                <option value="E">E</option>
                                <option value="J">J</option>
                            </select>
                            <input type="text" id="cedula" required class="flex-1 bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                        </div>
                    </div>
                    

                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1">TelÃ©fono</label>
                        <div class="flex gap-2">
                             <select id="areaCode" class="w-24 bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                                 <option value="58">ðŸ‡»ðŸ‡ª +58</option>
                                 <option value="1">ðŸ‡ºðŸ‡¸ +1</option>
                                 <option value="57">ðŸ‡¨ðŸ‡´ +57</option>
                             </select>
                             <input type="text" id="telefono" placeholder="4141234567" class="flex-1 bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                        </div>
                         <p class="text-[10px] text-gray-500 mt-1">Ingresa el nÃºmero sin el cero inicial.</p>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">Email</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">DirecciÃ³n / Notas</label>
                    <textarea id="direccion" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white outline-none focus:border-blue-500"></textarea>
                </div>

            </form>

            <div class="p-4 border-t border-gray-700 bg-gray-900 flex justify-end gap-2">
                <button id="cancelModal" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-gray-300">Cancelar</button>
                <button type="submit" form="clientForm" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold shadow-lg">Guardar Cliente</button>
            </div>
        </div>
    </div>


    <div id="modalDelete" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl p-6 max-w-sm w-full border border-gray-700 text-center">
            <input type="hidden" id="deleteId">
            <h3 class="text-xl font-bold text-white mb-2">Â¿Eliminar Cliente?</h3>
            <p class="text-gray-400 text-sm mb-6">Esta acciÃ³n no se puede deshacer.</p>
            <div class="flex gap-2 justify-center">
                <button id="btnCancelDelete" class="px-4 py-2 bg-gray-700 rounded text-white font-medium">Cancelar</button>
                <button id="btnConfirmDelete" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white font-bold">Eliminar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { includeMany } from '/assets/include.js';
        import initLayout from '/assets/js/layout.js';
        import { apiGet, apiPost, apiPut, apiDelete } from '/assets/js/api.js';
        import { Toast } from '/assets/js/toast.js';

        await includeMany([
            { selector: '#sidebar-slot', url: '/partials/sidebar.html' },
            { selector: '#topbar-slot', url: '/partials/topbar.html' }
        ]);
        await initLayout({ pageTitle: 'Clientes' });



        let allClients = [];
        const tableBody = document.getElementById('clientsTableBody');
        const modal = document.getElementById('clientModal');
        const form = document.getElementById('clientForm');
        const searchInput = document.getElementById('searchInput');
        const modalDelete = document.getElementById('modalDelete');



        async function loadClients() {
            try {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Cargando...</td></tr>';
                const data = await apiGet('clientes');
                allClients = data || [];
                renderClients(allClients);
            } catch(e) {
                console.error(e);
                tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error: ${e.message}</td></tr>`;
            }
        }

        function renderClients(list) {
            if (list.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No hay clientes registrados.</td></tr>';
                return;
            }
            tableBody.innerHTML = list.map(c => {
                 const code = c.area_number || '58';
                const num = c.telefono || '';
                const phoneDisplay = `(+${code}) ${num}`;

                return `
                <tr class="hover:bg-gray-700/50 transition-colors group">
                    <td class="px-6 py-3 font-bold text-white">${c.nombre || ''} ${c.apellido || ''}</td>
                    <td class="px-6 py-3 font-mono text-gray-300">${c.cedula || '-'}</td>
                    <td class="px-6 py-3 text-sm text-gray-300">${phoneDisplay}</td>
                    <td class="px-6 py-3 text-gray-400 text-xs">${c.email || ''}</td>
                    <td class="px-6 py-3 text-right">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.editClient('${c.id}')" class="p-2 bg-blue-900/50 text-blue-400 rounded hover:bg-blue-900 hover:text-white transition-colors" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </button>
                            <button onclick="window.deleteClient('${c.id}')" class="p-2 bg-red-900/50 text-red-400 rounded hover:bg-red-900 hover:text-white transition-colors" title="Eliminar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }



        searchInput.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const filtered = allClients.filter(c => 
                (c.nombre && c.nombre.toLowerCase().includes(q)) ||
                (c.apellido && c.apellido.toLowerCase().includes(q)) ||
                (c.cedula && c.cedula.includes(q))
            );
            renderClients(filtered);
        });



        const openModal = (title = 'Nuevo Cliente') => {
            document.getElementById('modalTitle').textContent = title;
            modal.classList.remove('hidden');
        };
        const closeModal = () => {
             modal.classList.add('hidden');
             form.reset();
             document.getElementById('clientId').value = '';
             document.getElementById('areaCode').value = '58';
        };



        document.getElementById('btnNewClient').addEventListener('click', () => openModal());
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelModal').addEventListener('click', closeModal);

        window.editClient = (id) => {
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            document.getElementById('clientId').value = client.id;
            document.getElementById('nombre').value = client.nombre || '';
            document.getElementById('apellido').value = client.apellido || '';
            document.getElementById('cedula').value = client.cedula || '';
            


            document.getElementById('areaCode').value = client.area_number || '58';
            document.getElementById('telefono').value = client.telefono || ''; 

            document.getElementById('email').value = client.email || '';
            document.getElementById('direccion').value = client.direccion || client.notas || ''; 

            openModal('Editar Cliente');
        };



        window.deleteClient = (id) => {
            document.getElementById('deleteId').value = id;
            modalDelete.classList.remove('hidden');
        };
        
        document.getElementById('btnCancelDelete').addEventListener('click', () => modalDelete.classList.add('hidden'));
        
        document.getElementById('btnConfirmDelete').addEventListener('click', async () => {
            const id = document.getElementById('deleteId').value;
            if (!id) return;
            try {
                await apiDelete(`clientes/${id}`);
                Toast.show('Cliente eliminado', 'success');
                modalDelete.classList.add('hidden');
                loadClients();
            } catch(e) {
                Toast.show('Error al eliminar: ' + e.message, 'error');
            }
        });




        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('clientId').value;
            const rawPhone = document.getElementById('telefono').value;
            

            const normalizedPhone = rawPhone.replace(/^0+/, '');

            const payload = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                cedula: document.getElementById('cedula').value,
                area_number: document.getElementById('areaCode').value,
                telefono: normalizedPhone,
                email: document.getElementById('email').value,
                direccion: document.getElementById('direccion').value
            };

            try {
                if (id) {
                    await apiPut(`clientes/${id}`, payload); 
                    Toast.show('Cliente actualizado', 'success');
                } else {
                    await apiPost('clientes', payload);
                    Toast.show('Cliente creado', 'success');
                }
                closeModal();
                loadClients();
            } catch(err) {
                Toast.show('Error: ' + err.message, 'error');
            }
        });



        loadClients();

    </script>
</body>
</html>