<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Dashboard Â· CafeterÃ­a</title>
</head>

<body data-page="dashboard" class="bg-gray-900 text-white min-h-screen">
  <div class="flex min-h-screen">

    <!-- Sidebar slot -->
    <div id="sidebar-slot"></div>

    <main class="flex-1">
      <!-- Topbar slot -->
      <div id="topbar-slot"></div>

      <!-- Content -->
      <div class="p-4 max-w-7xl mx-auto space-y-6">

        <!-- KPI cards -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700">
            <div class="text-sm text-gray-400">Ventas hoy</div>
            <div class="mt-2 text-3xl font-extrabold">$ ...</div>
            <div class="mt-1 text-xs text-green-400">+12% vs ayer</div>
          </div>
          <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700">
            <div class="text-sm text-gray-400">CrÃ©ditos hoy</div>
            <div class="mt-2 text-3xl font-extrabold">$ ...</div>
            <div class="mt-1 text-xs text-yellow-400">8 ventas a crÃ©dito</div>
          </div>
          <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700">
            <div class="text-sm text-gray-400">Pagos pendientes</div>
            <div class="mt-2 text-3xl font-extrabold">...</div>
            <div class="mt-1 text-xs text-red-400">Requieren validaciÃ³n</div>
          </div>
          <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700">
            <div class="text-sm text-gray-400">Stock bajo</div>
            <div class="mt-2 text-3xl font-extrabold">...</div>
            <div class="mt-1 text-xs text-gray-400">Productos crÃ­ticos</div>
          </div>
        </div>

        <!-- Panels -->
        <div class="grid lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 bg-gray-800 rounded-2xl p-4 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">Actividad reciente</h2>
                <p class="text-sm text-gray-400">Ãšltimos movimientos del sistema</p>
              </div>
              <button class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm">Ver todo</button>
            </div>

            <div id="activity-list" class="mt-4 space-y-3">
              <div class="text-sm text-gray-400">Cargando actividad...</div>
            </div>
          </div>

          <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700">
            <h2 class="text-lg font-semibold">Acciones rÃ¡pidas</h2>
            <p class="text-sm text-gray-400">Atajos frecuentes</p>
            <div class="mt-4 space-y-2">
              <a href="/pages/rates.html" class="block px-4 py-3 w-full rounded-xl bg-gray-700 hover:bg-gray-600 text-left">
                ðŸ’± Cargar tasa del dÃ­a
              </a>
              <a href="/pages/inventory.html" class="block px-4 py-3 w-full rounded-xl bg-gray-700 hover:bg-gray-600 text-left">
                ðŸ“¦ Ver stock por piso
              </a>
              <a href="/pages/customers.html" class="block px-4 py-3 w-full rounded-xl bg-gray-700 hover:bg-gray-600 text-left">
                ðŸ‘¤ Administrar clientes fijos
              </a>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- JS: load partials and initialize layout -->
  <script type="module">
    import { includeMany } from '/assets/include.js';
    import initLayout from '/assets/js/layout.js';
    import { requireRole } from '/assets/js/guard.js';
    import { apiGet } from '/assets/js/api.js';

    await includeMany([
      { selector: '#sidebar-slot', url: '/partials/sidebar.html' },
      { selector: '#topbar-slot', url: '/partials/topbar.html' }
    ]);

    await initLayout({ pageTitle: 'Dashboard' });

    // Only admins can access dashboard
    await requireRole(['admin']);

    async function loadDashboard() {
        // Set loading state
        const kpiValues = document.querySelectorAll('.grid .text-3xl');
        kpiValues.forEach(el => el.textContent = '...');
        const activityList = document.querySelector('#activity-list');

        try {
            console.log('Fetching dashboard metrics...');
            const data = await apiGet('api/dashboard/metrics');
            console.log('Dashboard data received:', data);
            
            if (!data || !data.today) throw new Error('Datos de dashboard invÃ¡lidos o vacÃ­os');

            // KPI Cards - Using safer indexes or specific IDs if we added them
            const cards = document.querySelectorAll('.grid .text-3xl');
            if (cards.length >= 4) {
                cards[0].textContent = `$ ${parseFloat(data.today.sales || 0).toFixed(2)}`;
                cards[1].textContent = `$ ${parseFloat(data.today.credits || 0).toFixed(2)}`;
                cards[2].textContent = data.pendingClients;
                cards[3].textContent = data.lowStock;
                
                // Update credit subtext
                const creditSub = document.querySelector('.grid div:nth-child(2) .text-xs');
                if (creditSub) creditSub.textContent = `${data.today.creditCount} ventas a crÃ©dito`;
            }

            // Activity
            if (activityList) {
                if (data.recentActivity && data.recentActivity.length > 0) {
                    activityList.innerHTML = data.recentActivity.map(act => `
                        <div class="bg-gray-900 rounded-xl p-3 border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="font-semibold">Venta Â· ${act.clientes ? act.clientes.nombre : 'Cliente Externo'}</div>
                                <span class="text-xs px-2 py-1 rounded ${act.metodo_pago === 'CREDITO' ? 'bg-yellow-600' : 'bg-green-600'}">
                                    ${act.metodo_pago}
                                </span>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                $ ${parseFloat(act.total).toFixed(2)} Â· ${new Date(act.fecha_venta).toLocaleString()}
                            </div>
                        </div>
                    `).join('');
                } else {
                    activityList.innerHTML = '<p class="text-center text-gray-500 py-4 italic">Sin actividad reciente</p>';
                }
            }

        } catch (error) {
            console.error('Error loading dashboard:', error);
            // Show error on cards
            kpiValues.forEach(el => el.textContent = 'Error');
            if (activityList) activityList.innerHTML = `<p class="text-red-400 text-center py-4">Error al cargar datos: ${error.message}</p>`;
        }
    }

    loadDashboard();
  </script>
</body>
</html>
